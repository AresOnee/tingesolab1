# ============================================
# DOCKER COMPOSE - TOOLRENT APPLICATION
# ============================================
# Servicios: MySQL, Backend (3 réplicas), Nginx Backend LB, Frontend (3 réplicas), Nginx Frontend LB, Keycloak

version: '3.8'

services:
  # ====== BASE DE DATOS MYSQL ======
  mysql:
    image: mysql:8.0
    container_name: toolrent-mysql
    restart: unless-stopped
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: toolrent
      MYSQL_USER: toolrent
      MYSQL_PASSWORD: toolrent123
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-database.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot123"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ====== KEYCLOAK (IAM) ======
  keycloak:
    image: quay.io/keycloak/keycloak:26.3.3
    container_name: toolrent-keycloak
    restart: unless-stopped
    command: start-dev --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: mysql
      KC_DB_URL: jdbc:mysql://mysql:3306/keycloak
      KC_DB_USERNAME: root
      KC_DB_PASSWORD: root123
      KC_HOSTNAME_STRICT: false
      KC_HTTP_ENABLED: true
      KC_HTTP_PORT: 8080
    ports:
      - "9090:8080"
    volumes:
      - ./keycloak-config:/opt/keycloak/data/import:ro
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080 && exec 3>&- && exec 3<&-"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 120s

  # ====== BACKEND - REPLICA 1 ======
  backend-1:
    build:
      context: ./backend-toolrent
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-fergusone}/toolrent-backend:latest
    container_name: toolrent-backend-1
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_HOST: mysql
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/toolrent
      SPRING_DATASOURCE_USERNAME: toolrent
      SPRING_DATASOURCE_PASSWORD: toolrent123
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://host.docker.internal:9090/realms/sisgr-realm/protocol/openid-connect/certs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mysql:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ====== BACKEND - REPLICA 2 ======
  backend-2:
    build:
      context: ./backend-toolrent
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-fergusone}/toolrent-backend:latest
    container_name: toolrent-backend-2
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_HOST: mysql
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/toolrent
      SPRING_DATASOURCE_USERNAME: toolrent
      SPRING_DATASOURCE_PASSWORD: toolrent123
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://host.docker.internal:9090/realms/sisgr-realm/protocol/openid-connect/certs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mysql:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ====== BACKEND - REPLICA 3 ======
  backend-3:
    build:
      context: ./backend-toolrent
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-fergusone}/toolrent-backend:latest
    container_name: toolrent-backend-3
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_HOST: mysql
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/toolrent
      SPRING_DATASOURCE_USERNAME: toolrent
      SPRING_DATASOURCE_PASSWORD: toolrent123
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://host.docker.internal:9090/realms/sisgr-realm/protocol/openid-connect/certs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mysql:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ====== NGINX LOAD BALANCER (para Backend) ======
  nginx-backend:
    image: nginx:1.25-alpine
    container_name: toolrent-nginx-backend
    restart: unless-stopped
    ports:
      - "8090:80"
    volumes:
      - ./nginx-backend.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend-1
      - backend-2
      - backend-3
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ====== FRONTEND - REPLICA 1 ======
  frontend-1:
    build:
      context: ./toolrent-frontend
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-fergusone}/toolrent-frontend:latest
    container_name: toolrent-frontend-1
    restart: unless-stopped
    depends_on:
      - nginx-backend
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ====== FRONTEND - REPLICA 2 ======
  frontend-2:
    build:
      context: ./toolrent-frontend
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-fergusone}/toolrent-frontend:latest
    container_name: toolrent-frontend-2
    restart: unless-stopped
    depends_on:
      - nginx-backend
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ====== FRONTEND - REPLICA 3 ======
  frontend-3:
    build:
      context: ./toolrent-frontend
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-fergusone}/toolrent-frontend:latest
    container_name: toolrent-frontend-3
    restart: unless-stopped
    depends_on:
      - nginx-backend
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ====== NGINX LOAD BALANCER (para Frontend) ======
  nginx-frontend:
    image: nginx:1.25-alpine
    container_name: toolrent-nginx-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx-frontend.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend-1
      - frontend-2
      - frontend-3
    networks:
      - toolrent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/nginx-frontend-health"]
      interval: 30s
      timeout: 5s
      retries: 3

# ====== NETWORKS ======
networks:
  toolrent-network:
    driver: bridge
    name: toolrent-network

# ====== VOLUMES ======
volumes:
  mysql_data:
    driver: local
    name: toolrent-mysql-data
